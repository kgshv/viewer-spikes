<!DOCTYPE html>
<html>
  <head>
    <title>Render Test</title>
    <style>
      * {
        margin: 0;
        padding: 0; }
      
      .wrapper {
        border: 2px solid black;
        position: absolute;
        top: 2em;
        right: 2em;
        bottom: 2em;
        left: 2em;
        overflow: scroll;
        margin: 1em auto;
        -webkit-overflow-scrolling: touch; }
      
      .pages {
        margin: 0 auto;
        width: 100%; }

      .wrapper.zoom-1 .pages {width: 50%;}
      .wrapper.zoom-2 .pages {width: 75%;}
      .wrapper.zoom-3 .pages {width: 100%;}
      .wrapper.zoom-4 .pages {width: 125%;}
      .wrapper.zoom-5 .pages {width: 150%;}
      
      .wrapper.full-screen {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .wrapper.fixed-size {
        top: auto;
        right: auto;
        bottom: auto;
        left: auto;
        width: 600px;
        height: 900px;
      }
      .page {
        position: relative;
        width: 100%;
        margin-top: 20px;
        background: red;
        border: 2px solid #999;
        height: 0; }
        .page img {
          width: 100%; }
        .page .number,
        .page .annotations {
          position: absolute;
          left: 0;
          top: 0;
          max-height: 10em;
          overflow: hidden; }
        .page.loaded {
          border-color: green; }

        .liner {
          background: yellow;
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
        }
    </style>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/bacon.js/0.3.5/Bacon.min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/javascript-state-machine/2.0.0/state-machine.min.js" type="text/javascript"></script>

    <script src="javascripts/bacon_extensions.js" type="text/javascript"></script>
    <script src="javascripts/namespace.js" type="text/javascript"></script>
    <script src="javascripts/documents.js" type="text/javascript"></script>
    <script src="javascripts/renderer.js" type="text/javascript"></script>
    <script src="javascripts/renderer_page.js" type="text/javascript"></script>

    <script type="text/javascript">
      // An experiment with a simple state machine using Bacon. Events are 
      // pushed via state.events.push(...). State updates are published via the
      // state.current stream.
      var State = function(config) {
        this.machine = new StateMachine.create(config);
        this.current = new Bacon.Bus();
        this.current.push({state: this.machine.current});
      };

      State.prototype = {
        trigger: function(name, data) {
          if (this.machine.can(name)) {
            this.machine[name]();
            this.current.push({state: this.machine.current, data: data});
          }
        }
      };

      // Data is basically a key/value store, where the values are only
      // accessible via event streams
      var Data = function(initial) {
        for (var prop in initial) {
          if (_.has(initial, prop)) {
            var bus = this[prop + '_bus'] = new Bacon.Bus();
            this[prop] = bus.skipDuplicates().toProperty();
            if (!_.isEmpty(initial[prop])) {
              bus.push(initial[prop]);
            }
          }
        }

        this.all_bus = new Bacon.Bus();
        this.all = this.all_bus.skipDuplicates();
      };

      Data.prototype = {
        set: function(key, value) {
          this[key + '_bus'].push(value);
          this.all_bus.push({key: key, value: value});
        }
      };

      $(function() {
        // Boostrap test state machine
        state = new State({
          initial: 'green',
          events: [
            { name: 'warn',  from: 'green',  to: 'yellow' },
            { name: 'panic', from: 'yellow', to: 'red'    },
            { name: 'calm',  from: 'red',    to: 'yellow' },
            { name: 'clear', from: 'yellow', to: 'green'  }
          ]
        });

        // Create a data store
        data = new Data({
          state       : state.current, 
          zoomLevel   : '3',
          viewerMode  : 'full-screen',
          currentPage : null
        });

        // Create a subscription to state updates which updates the state in 
        // our data store.
        state.current.onValue(function(update) {
          data.set('state', update.state, update.data);
        });

        // Subscribe to any changes on the data
        data.all.onValue(function(update) {
          console.log('Update for', update.key, update.value);
        });

        // Subscribe to changes only on the 'zoomLevel' key
        data.zoomLevel.onValue(function(value) {
          console.log('Zoom level is', value);
        });

        renderer = new DV.views.Renderer({data: data});
        $('body').append(renderer.render().el);
        renderer.setDocument(null);

        // Set the first page.
        data.set('currentPage', {page: 0});

      });
    </script>
  </head>

  <body>
  </body>
</html>
