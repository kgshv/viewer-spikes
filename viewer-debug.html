<!DOCTYPE html>
<html>
  <head>
    <title>Derp</title>
    <style>
      * {
        margin: 0;
        padding: 0; }
      
      .wrapper {
        border: 2px solid black;
        width: 900px;
        height: 500px;
        overflow: scroll; }
      
      .pages {
        margin: 0 auto;
        width: 600px; }
      
      .page {
        position: relative;
        width: 100%;
        min-height: 906px;
        margin-top: 20px;
        background: red; }
        .page img {
          width: 100%; }
        .page .number,
        .page .annotations {
          position: absolute;
          left: 0;
          top: 0;
          max-height: 10em;
          overflow: hidden; }
    </style>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/bacon.js/0.3.5/Bacon.min.js" type="text/javascript"></script>

    <script type="text/javascript">
      var DV = {views: {}};
      DV.views.Renderer = Backbone.View.extend({
        className: 'wrapper',
        tagName: 'div',

        DEFAULT_HEIGHT: 906,

        initialize: function() {
          this.pageEls = [];
          this.cache = {};
        },

        setDocument: function(doc) {
          this.renderPageElements();
          this.calculateGeometry();
          this.boostrapStreams();
        },

        loadPage: function() {

        },

        calculateGeometry: function() {
          this.geometry = _.map(this.pageEls, function(el) {
            var top = el.offset().top, height = el.height();
            return {
              top     : top,
              bottom  : top + height,
              height  : height
            };
          }, this);
        },

        mapCurrentPage: function(e) {
          var topBound = $(e.target).scrollTop();
          var bottomBound = topBound + this.pagesEl.height();

          for (var i = 0; i < this.geometry.length; i++) {
            var entry = this.geometry[i];

            // if topbound is less than the mid-point
            // or if bottombound is greater than the mid-point
            if ((entry.top >= topBound && entry.top <= bottomBound) ||
                (entry.bottom >= topBound && entry.bottom <= bottomBound) ||
                (entry.top <= topBound && entry.bottom >= bottomBound)) {
              return i;
            }
          }

          return -1;
        },

        loadPage: function(page) {
          console.log('Loading Page:', page);
        },

        renderPageElements: function() {
          for (var i = 0; i < 100; i++) {
            var pageEl = $('<div class="page"></div>').height(this.DEFAULT_HEIGHT);
            this.pageEls[i] = pageEl;
            this.pagesEl.append(pageEl);
          }
        },

        boostrapStreams: function() {
          this.currentPage = this.$el.asEventStream('scroll')
                                     .throttle(200)
                                     .map($.proxy(this, 'mapCurrentPage'))
                                     .skipDuplicates();

          this.currentPage.onValue(function(page) {
            console.log('Current Page:', page);
          });

          this.currentPage.debounce(1000).onValue($.proxy(this, 'loadPage'));
        },

        render: function() {
          this.pagesEl = $('<div class="pages"></div>');
          this.$el.append(this.pagesEl);

          return this;
        }
      });

      $(function() {
        renderer = new DV.views.Renderer();
        $('body').append(renderer.render().el);
        renderer.setDocument(null);
      });
    </script>
  </head>

  <body>
  </body>
</html>
